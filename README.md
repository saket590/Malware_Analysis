# Malware_Analysis Step by Step Process

In this exercise, We’ll be performing static and dynamic analysis of 0.exe malware to understand it’s behaviour by analyzing it’s sample and as an outcome creating a signature to detect it.

We will determine the malware’s activities on the machine, locations to inspect and a brief on tools that’ll be used to analyze the sample.

**Lab Environment:**

The base system is Kali Linux and the experimental system is Windows 10 VM inside kali linux.

**Static Analysis Tools:**

To perform static analysis I’m using the below list of tools.

File → To see file type
md5sum/sha1sum → To generate a hash of sample
Strings → To extract strings from sample
Pe studio → To see imports/ functions of an executable
Virustotal → to check the reputation of hashes and malware attributes.

Other tools can be used dpeneding upon your requirement. The tools are: **FLOSS, Sysinternals Strings, and Fireeye stringsifter**.

**File Type:**

To begin with, the malware file type should be tested regardless of what it displays. Malware authors often rename the binary with other extensions to trick the user into clicking them. For example, the file with .pdf extension can be a .exe executable underneath. Checking the file type confirms if it’s a PE(Portable Executable) or if it’s of any other format.Few tools to check a file type are PE studio, CFF Explorer, ExifTool

The file command utility used here and it shows its PE executable file.

**Command: file filename**

**Fingerprinting** the malware means generating the hash value of a malware’s sample. This can be used to collect further information such as the malware’s family, IOC’s, and malware’s attributes from a malware repository.

In this example we are generating MD5 hashes.This hash value is used for virustotal analyses.
**Note:** Virustotal can also be used to identify hashes of the malware. Just upload the file on virustotal and check the details section.

**Command: md5sum 0.exe**

**String Extraction:**

A malware analyst can benefit from testing extraction in a number of ways. String extraction from a sample may disclose a Command and Control (C2) IP address or harmful URLs that the virus may use when run.

Signatures are made using the retrieved strings. They can also be used to search your network for other infected computers. These retrieved IP addresses and domain names from the examined malware are utilized as IOCs and should be verified with firewall and proxy logs for a potential penetration. Other than string command, following tools can be used to extract information from the executable.

**Strings Analysis Tools:**
-FLOSS
-Sysinternals Strings
-Fireeye stringsifter

The strings command utility and pe studio are the two examples I’ve used here.

**Command: strings 0.exe**

It is important to examine the DLLs used by the malware, it will help us understand the behavior of it.

Here I am using the **PE studio tool** to examine the DLLs loaded by the malware and from the analysis it shows 0.exe uses the below DLLs:

**-Win32
-svchost
-rundll
-system32
Wininit.dll
**

The DLL analysis mentioned above shows that 0.exe will be altering the registry and connecting via HTTP/HTTPS to the C2 server.

The PE studio provides us the option of analyzing API calls used by imported DLLs. This option helps us with a detailed picture of which API calls are used and what changes in the system.

For example, 0.exe deletes registry keys and change values in the registry using **RegDeleteValueA & RegFlushKey.**

**Virustotal:**

The majority of the malware and virus data, including the malware family, IP addresses, and domain names utilized by the malware, may be found in the threat intelligence repository known as Virustotal. If this malware has already been identified and categorized, Virustotal analysis on malware samples will show us. It displays any connections to currently active malicious files, associated IOCs, etc.

You can submit a sample of the malware, but merely looking up the hash value will tell us all we need to know.

**YARA:** YARA is a tool designed to help malware researchers identify and classify malware samples. It’s been called the pattern-matching Swiss Army knife for security researchers.

**Dynamic Analysis:**
In dynamic analysis we execute the malware sample in an isolated environment and monitor for the below changes:

_**-Files created by malware
-Changes done in the system
-IPs/Domains connected
-Registry changes
-Log files entries
-Network Behavior
-Open Ports**

**Lab Setup:**
To perform dynamic analysis, I created a lab environment in which I’ll execute the malware sample in Windows 10 VM and route the traffic via Kali Linux machine to monitor network requests like DNS, HTTP, etc.

**Dynamic / Behavioral Analysis Tools:**

-Process Explorer
-Process Monitor
-Process Hacker
-CaptureBAT
-Sysmon
-API Monitor
-CMD Watcher
-Autoruns
-Regshot
-Flypaper (Password : “rich”)
-Microsoft ASA (Attack Surface Analyzer)
-INet Simulator
-Noriben

**Process Explorer:**
The Process Explorer display consists of two sub-windows. The top window always shows a list of the currently active processes, including the names of their owning accounts, whereas the information displayed in the bottom window depends on the mode that Process Explorer is in: if it is in handle mode you'll see the handles that the process selected in the top window has opened; if Process Explorer is in DLL mode you'll see the DLLs and memory-mapped files that the process has loaded. Process Explorer also has a powerful search capability that will quickly show you which processes have particular handles opened or DLLs loaded.

The unique capabilities of Process Explorer make it useful for tracking down DLL-version problems or handle leaks, and provide insight into the way Windows and applications work.

**INet Simulator**:

Malware may establish a network connection with a C2 (Command & Control) server while it is running in a system to receive further commands or to upload data from an infected host. However, since we shouldn't enable malware to connect to C2 while performing malware analysis, we run a network simulator that will fake out any responses the virus sends to network requests. In this experiment, outbound connection requests initiated by running brbbot.exe are handled by the INet simulator.

**Noriben:**

The Noriben is a python script available in github, it will help us to monitor the system changes such as file system changes, registry changes and new network communications.The Noriben uses ProcMon to log all the file system changes, registry changes, network communications while it’s running.

Setup:
Download and install python in the system
Download Noriben from github and should add ProcMon in the same folder before executing.

After the malware execution, you can stop Noriben and it automatically logs activity in a text file and exports it as a .CSV.

**Wireshark:**
Wireshark is used to capture packets in the network for analysis. When we execute brbbot.exe, wireshark captures all the outbound connections from the Windows VM.

**Wireshark Observations:**

As we expected the malware is making an outbound connection to a C2 server 
The INetsim is responding to the DNS request with Ubuntu VM’s IP as DNS response.
The Windows VM tries to connect the C2 IP(in this case Ubuntu VM’s IP) by initiating a TCP handshake.
In the real world, malware would have connected with the C2 server to download further instructions to perform malicious activity.
















